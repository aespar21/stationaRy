---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

```{r packages, message=FALSE, warning=FALSE, include=FALSE}
library(stationary)
library(tidyverse)
library(lubridate)
```

# stationary <a href='http://rich-iannone.github.io/stationary/'><img src="man/figures/logo.svg" align="right" height="139px" /></a>

[![CRAN status](https://www.r-pkg.org/badges/version/stationary)](https://CRAN.R-project.org/package=stationary)
[![Travis-CI Build Status](https://travis-ci.org/rich-iannone/stationary.svg?branch=master)](https://travis-ci.org/rich-iannone/stationary)
[![AppVeyor build status](https://ci.appveyor.com/api/projects/status/github/rich-iannone/stationary?branch=master&svg=true)](https://ci.appveyor.com/project/rich-iannone/stationary)
[![Codecov test coverage](https://codecov.io/gh/rich-iannone/stationary/branch/master/graph/badge.svg)](https://codecov.io/gh/rich-iannone/stationary?branch=master)

## Overview

Get hourly meteorological data from met stations all over the world. That's what you can do with this **R** package. There are *LOTS* of stations too (29,729 available in this dataset) and many have data that goes way back.

### Retrieving Met Data with a `station_id`

Let's get some met data from La Guardia Airport! (the ID value for that one is `"725030-14732"`). This station has a pretty long history (starting operations in 1973) but we'll just grab data from the years of 2017 and 2018.

```{r get_met_data, echo=TRUE, results="hide"}
lga_met_data <- 
  get_met_data(
    station_id = "725030-14732",
    years = 2017:2018
  )
```

```{r lga_met_data}
lga_met_data
```

### Discovering Met Stations

There are lots of stations and we at least need an identifier to access the met data. We can examine station metadata using the `get_station_metadata()` function (which has those ID values in the first column). Let's get all of the stations located in Norway.

```{r stations_norway}
stations_norway <- 
  get_station_metadata() %>%
  filter(country == "NO")

stations_norway
```

This table can be greatly reduced to isolate the stations of interest. For example, with `dplyr::filter()` we could get only high-altitude stations (above 1000 meters) in Norway. 

```{r norway_high_elev}
norway_high_elev <-
  stations_norway %>% 
  filter(elev > 1000)

norway_high_elev
```

The station IDs from the tibble can be transformed into a vector of station IDs with `dplyr::pull()`.

```{r norway_high_elev_ids}
norway_high_elev %>% pull(id)
```

Suppose you'd like to collect several years of met data from a particular station and get only a listing of parameters that meet some criterion. Here's an example of obtaining temperatures above 15 degrees Celsius from the high-altitude `"JUVVASSHOE"` station in Norway:

```{r echo=TRUE, results="hide"}
station_data <- 
  get_station_metadata() %>%
  filter(name == "JUVVASSHOE") %>%
  pull(id) %>%
  get_met_data(years = 2011:2019)

high_temp_data <-
  station_data %>%
  select(id, time, wd, ws, temp) %>% 
  filter(temp > 16) %>%
  mutate(temp_f = ((temp * (9/5)) + 32) %>% round(1)) %>%
  arrange(desc(temp_f))
```

```{r high_temp_data}
high_temp_data
```

### Additional Data Fields

There can actually be a lot of additional met data beyond wind speed, temperatures, etc. It can vary greatly depending on the selected station. These additional categories are denoted 'two-letter + digit' identifiers (e.g., `AA1`, `GA1`, etc.). Within each category are numerous variables (coded as `[identifer]_[index]`). More information about these variables can be found in [this PDF document](http://www1.ncdc.noaa.gov/pub/data/ish/ish-format-document.pdf).

To find out which categories of additional met fields are available for a station, use the `station_coverage()` function. You'll get a tibble with the available additional categories and their counts over the specified period.

```{r echo=TRUE, results="hide"}
# Get information on which additional met data
# fields are available at the Juvvasshoe station
additional_data_fields <-
  get_station_metadata() %>%
  filter(name == "JUVVASSHOE") %>%
  pull(id) %>%
  station_coverage(years = 2015)
```

```{r additional_data_fields}
additional_data_fields
```

We can use **purrr**'s `map_df()` function to get additional data field coverage for a subset of stations (those that are near sea level and have data in 2019). With the `station_coverage()` function set to output tibbles in `wide` mode (one row per station, field categories as columns, and counts of observations as values), we can ascertain which stations have the particular fields we need.

```{r many_stations_fields, echo=TRUE, results="hide"}
stns <- 
  get_station_metadata() %>%
  filter(country == "NO", elev <= 5 & end_year == 2019)

coverage_tbl <- 
  purrr::map_df(
    seq(nrow(stns)),
    function(x) {
      stns %>%
        pull(id) %>%
        .[[x]] %>%
        station_coverage(
          years = 2019,
          wide_tbl = TRUE
        )
    }
  )
```

```{r coverage_tbl}
coverage_tbl
```

For the `"KAWAIHAE"` station in Hawaii, some interesting data fields are available. In particular, its `SA1` category provides sea surface temperature data, where the `sa1_1` and `sa1_2` variables represent the sea surface temperature and its quality code.

Combining the use of `get_met_data()` with functions from **dplyr**, we can create a table of the mean ambient and sea-surface temperatures by month. The additional data is included in the met data table by using the `add_fields` argument and specifying the `"SA1"` category (multiple categories can be included). 

```{r sa1_field, echo=TRUE, results="hide"}
# Get the average ambient temperature and the
# average sea-surface temperatures (sst) from
# the "KAWAIHAE" station for every available month
kawaihae_sst <- 
  get_met_data(
    station_id = "997173-99999",
    years = 2017:2018,
    add_fields = "SA1"
  ) %>%
  mutate(
    year = lubridate::year(time),
    month = lubridate::month(time)
  ) %>%
  filter(sa1_2 == 1) %>%
  group_by(year, month) %>%
  summarize(
    avg_temp = mean(temp, na.rm = TRUE),
    avg_sst = mean(sa1_1, na.rm = TRUE)
  )
```

```{r kawaihae_sst}
kawaihae_sst
```

## Installation

To install the development version of **stationary**, use the following:

```{r install_github, eval=FALSE}
install.packages("devtools")
remotes::install_github("rich-iannone/stationary")
```

If you encounter a bug, have usage questions, or want to share ideas to make this package better, feel free to file an [issue](https://github.com/rich-iannone/stationary/issues).

## Code of Conduct

Please note that the **stationary** project is released with a [Contributor Code of Conduct](CODE_OF_CONDUCT.md). By contributing to this project, you agree to abide by its terms.

## License

MIT &copy; Richard Iannone
